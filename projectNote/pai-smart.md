# 面试题
## 介绍项目从数据上传到最后存入数据库、RAG的过程
### 文件上传
#### 流程：
思路： 对于大文件，派聪明采用的是 ‘分片上传+断点续传’ 的方式。
1. 在前端先把大文件切成小的分片 -> 并发地上传到后端 -> 后端 每收到一个分片，就存到MinlO中，同时会用Redis的bitmap去记录哪些分片已经上传成功。  
    - 1.1 好处: 即使上传过程中断了，前端可以根据 Redis状态判断哪些分片已经上传，不用从头开始
    - 1.2 前端上传的每个分片内容包括：元信息（文件MD5 + chunkId）、分片本身数据
    - 1.3 redis结构： 文件MD5: bitmap
2. 首次上传分片会将文件元信息存入Mysql，方便后续文件 状态、权限 的管理。
3. 分片上传完，调用合并接口，里面使用了Minio的composeObject()，实现在存储端合并，不阻塞主进程。随后：
   - 3.1 删除redis的临时文件
   - 3.2 Mysql中文件表标记当前文件为“已完成”
（注意！此处有一致性问题）
4. 合并结束后发送Kafka信息，并直接返回前端“上传成功”。

####  上传异常处理
1. 上传失败：前端重试3次 + 每次重试等待时间延长 + 失败上报业务层
2. 重复上传：redis判幂等
3. 数据完整性：每个分片都有独立MD5，后端收到再算一遍，保证每个分片都完整；合并之后再算总的文件的MD5
4. 服务挂了：前端兜底，返回“服务异常请重试”，恢复后由前端重试机制重新发起上传请求

#### 上传原子性
总览：目前并没有做到“跨所有系统”的强原子；而是靠“3层保护”把不一致窗口压到最小，并在失败时通过“半回滚+补偿”来收敛。
- 三层保护：  
![合并3层保护.png](images%2F%E5%90%88%E5%B9%B63%E5%B1%82%E4%BF%9D%E6%8A%A4.png)
- 执行顺序：
  - 1\. composeObject // 成功后 →
  - 2\. removeObject // 刪除所有分片
  - 3\. deleteFileMark // 删除Redis位图
  - 4\. update DB // status=1
  - 5\. 发Kafka // 解析向量化
- 失败回滚和补偿：  
![失败回滚补偿.png](images%2F%E5%A4%B1%E8%B4%A5%E5%9B%9E%E6%BB%9A%E8%A1%A5%E5%81%BF.png)
- 改进空间：
  - （1）DB 和 Kafka 的一致性通过 本地消息表
    - 【step1】业务表+消息表（spring事务）：本地建消息表，更新业务时同时更新事务表，两个表一致性通过数据库事务保证。
    - 【step2】定时任务扫描日志：独立线程定时扫描消息表中的消息，并发送至mq，在mq反馈ack后删除该消息日志，否则等待定时任务下一周期重试。
    - 【step3】消费消息：为保证消费者一定消费到消息，消费者需 “先执行，再提交offset”。
    - （消息表字段：业务唯一id + 要发送的topic和对应的消息key + 消息内容 + 发送状态 + 重试次数）
  - （2）先发kafka，再删分片
    - 原因：后台解析成功再删分片，降低误删概率
  - （3）定时对账：
    - 如定期检查 mysql中文件上传状态 和 实际文件对象，如不一致则补偿
  - （4）定时清理脏数据：
    - 凌晨定时扫描minio，发现长时间未合并文件，标记为问题数据，进行清除



### 文件存储

### 向量生成

### 答案生成

## 模型为什么选 Deepseek-V3?

DeepSeek的主要优势在于，与OpenAI或Google等竞争对手相比，它能够以明显更低的成本提供高性能。

### Deepseek 和 Qwen 对比
#### Qwen2-Plus-Latest更适合：
多语言产品（特别是中日英韩语种）
对话式应用和复杂指令处理
对语言细腻度要求较高的创作类场景
（关键词：多语言，复杂模糊指令，创作能力）

#### DeepSeek-V3更适合：
开发者工具和编程辅助应用
长文档处理、知识库问答和学术研究
对长上下文连贯性要求高的分析任务
（关键词：长文档，知识库问答，专业领域研究，成本更低）


### Deepseek-V3 和 Deepseek-R1 对比
#### Deepseek R1概述:
Deepseek R1，全称Deepseek Reasoner，是一款专注于推理能力的大型语言模型。
它采用了专门的训练方法，强化了模型在复杂逻辑推理、数学求解、代码分析等方面的能力。
R1的主要特点是在处理需要深度思考的问题时表现出色，能够提供详细的推理过程和精确的结论。

#### Deepseek V3概述
Deepseek V3，即Deepseek Chat，是Deepseek推出的新一代通用对话模型。
相比R1，V3在通用对话、指令遵循、创意内容生成等方面做了全面优化，使其更适合日常对话和多样化的应用场景。
V3注重平衡多方面能力，提供更流畅自然的交互体验。

#### 对比

## 流式响应 websocket相关

